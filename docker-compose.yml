services:
  repo_ingestion:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    image: refactor-repo-ingestion:latest
    ports:
      - "8000:8000"
    volumes:
      # Share the same named volume across services
      - workspace:/workspace
    environment:
      PYTHONUNBUFFERED: "1"
    restart: unless-stopped

  orchestrator:
    build:
      context: .
      dockerfile: docker/agent/Dockerfile
    image: refactor-orchestrator:latest
    volumes:
      # Allow orchestrator to create sandbox containers (Docker-outside-of-Docker)
      - /var/run/docker.sock:/var/run/docker.sock
      # Share the same named volume across services
      - workspace:/workspace
    environment:
      PYTHONUNBUFFERED: "1"
    restart: unless-stopped

  sandbox_base:
    build:
      context: .
      dockerfile: docker/sandbox/Dockerfile
    image: refactor-sandbox:latest
    profiles: ["manual"]

volumes:
  workspace:
    # Lock the actual Docker volume name to exactly "workspace"
    name: workspace

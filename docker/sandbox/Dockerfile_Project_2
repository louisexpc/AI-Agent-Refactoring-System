# syntax=docker/dockerfile:1.7
FROM debian:bookworm-slim

ARG DEBIAN_FRONTEND=noninteractive

# Pin versions for reproducibility (override at build time if needed)
ARG RUBY_VERSION=3.3.4
ARG GO_VERSION=1.22.10
ARG NODE_VERSION=20.11.1

# Common paths
ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    WORKDIR=/workspace

# ---- Base OS deps (build tools + common libs) ----
# Notes:
# - build-essential / libssl-dev / zlib1g-dev ... are typical for building Ruby gems with native extensions
# - sqlite3 is included as a lightweight default DB option (repo supports SQLite per README)
# - libpq-dev / default-mysql-client are included as "client+headers" only (servers are not installed)
RUN apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates curl git bash \
      build-essential pkg-config make cmake \
      libssl-dev zlib1g-dev libreadline-dev libyaml-dev libffi-dev libgdbm-dev libncurses5-dev libjemalloc-dev \
      sqlite3 libsqlite3-dev \
      libpq-dev default-mysql-client \
      tzdata \
      python3 python3-pip \
    && rm -rf /var/lib/apt/lists/*

# ---- Install Ruby (via ruby-build) ----
# We use ruby-build so you can align to .ruby-version / Gemfile.lock constraints when needed.
RUN git clone --depth 1 https://github.com/rbenv/ruby-build.git /tmp/ruby-build \
    && /tmp/ruby-build/install.sh \
    && ruby-build "${RUBY_VERSION}" /opt/ruby \
    && rm -rf /tmp/ruby-build
ENV PATH=/opt/ruby/bin:$PATH
RUN gem update --system && gem install bundler

# ---- Install Go ----
RUN curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tgz \
    && rm -rf /usr/local/go \
    && tar -C /usr/local -xzf /tmp/g

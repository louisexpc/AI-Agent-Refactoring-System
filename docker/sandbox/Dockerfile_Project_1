# syntax=docker/dockerfile:1.7
FROM debian:bookworm-slim

ARG DEBIAN_FRONTEND=noninteractive
ARG USER=sandbox
ARG UID=1000
ARG GID=1000

# Rust toolchain (>= 1.70). You can override at build time:
#   docker build --build-arg RUST_TOOLCHAIN=1.78.0 -t xml-sandbox .
ARG RUST_TOOLCHAIN=stable
ENV RUSTUP_HOME=/opt/rustup \
    CARGO_HOME=/opt/cargo \
    PATH=/opt/cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Base build + tooling
RUN apt-get update && apt-get install -y --no-install-recommends \
      bash \
      ca-certificates \
      curl \
      git \
      make \
      gcc \
      g++ \
      pkg-config \
      cmake \
      libc6-dev \
      file \
      python3 \
      python3-venv \
      python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install rustup (non-interactive) + minimal profile toolchain
# rustup is the recommended way to manage Rust toolchains. :contentReference[oaicite:2]{index=2}
RUN curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain ${RUST_TOOLCHAIN} \
    && chmod -R a+rX ${RUSTUP_HOME} ${CARGO_HOME}

# Create non-root user and give write access to toolchain dirs (so cargo can cache builds)
RUN groupadd -g ${GID} ${USER} \
    && useradd -m -u ${UID} -g ${GID} -s /bin/bash ${USER} \
    && mkdir -p /workspace \
    && chown -R ${USER}:${USER} /workspace ${RUSTUP_HOME} ${CARGO_HOME}

WORKDIR /workspace
USER ${USER}

# Convenience defaults
ENV CARGO_TERM_COLOR=always

CMD ["/bin/bash"]
